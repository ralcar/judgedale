<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel='import' href='../bower_components/vaadin-upload/vaadin-upload.html'>
<link rel='import' href='../bower_components/paper-toast/paper-toast.html'>
<link rel='import' href='../bower_components/paper-radio-group/paper-radio-group.html'>
<link rel='import' href='../bower_components/paper-button/paper-button.html'>
<link rel='import' href='../bower_components/paper-input/paper-input.html'>
<link rel='import' href='../bower_components/paper-button/paper-button.html'>
<link rel='import' href='../bower_components/iron-image/iron-image.html'>
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel='import' href='../bower_components/cpol-image/cpol-image.html'>
<link rel="import" href="shared-styles.html">
<link rel="import" href="jd-card.html">

<dom-module id="jd-add">
  <template>
    <style include="shared-styles">
       :host {
        display: block;

        padding: 10px;
      }

      .preview {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      vaadin-upload.orange {
        --primary-color: var(--paper-deep-orange-900);
      }

      paper-button.orange {
        background-color: var(--paper-deep-orange-900);
        color: #fff;
      }

      paper-radio-button.orange {
        --paper-radio-button-checked-color: var(--paper-deep-orange-900);
        --paper-radio-button-unchecked-color: var(--paper-deep-orange-900);
      }

      jd-card {
        width: 100%;
        max-width: 960px;
      }

      .card {
        width: 100%;
        max-width: 960px;
      }

    </style>

    <app-location route="{{route}}"></app-location>
    <div class="preview">
      <div class="card">

        <paper-radio-group selected="{{judgementType}}" on-selected-changed="resetForm">
          <paper-radio-button class="orange" name="image">Image</paper-radio-button>
          <paper-radio-button class="orange" name="video">Video</paper-radio-button>
        </paper-radio-group>



        <div hidden$="{{addingVideo}}">

          <vaadin-upload id="imageUpload" class="orange" accept=".jpg,.png,.gif,.bmp" files="{{selectedImages}}" max-files="1" on-file-reject="showRejectedFileError"
            on-upload-before="loadPreviewImage">
          </vaadin-upload>

          <cpol-image
            id="imageResizer"
            output-data="{{imageResizeResult}}"
            output-type="base64"
            max-width="960"
            max-height="720"
            image-quality="0.8"
            on-this-error-changed="handleError">
          </cpol-image>

        </div>

        <div hidden$="{{!addingVideo}}">
          <paper-input label="Youtube link" value="{{judgement.videoURL}}"></paper-input>
        </div>

        <paper-input label="Question" value="{{judgement.question}}"></paper-input>

        <paper-input label="My name is" value="{{judgement.username}}"></paper-input>

        <paper-button class="orange" raised on-tap="askForJudgement">Judge me</paper-button>


        <paper-toast id="toast" horizontal-align="right"></paper-toast>
      </div>

      <h1>Preview</h1>
      <jd-card judgement="{{judgement}}" preview-mode></jd-card>
    </div>

  </template>

  <script>
    class JudgeDaleAdd extends Polymer.Element {
      static get is() {
        return 'jd-add';
      }

      static get properties() {
        return {
          judgementType: {
            type: String,
            value: "image"
          },
          addingVideo: {
            type: Boolean,
            computed: 'computeIfAddingVideo(judgementType)'
          },
          selectedImages: Array,
          judgement: {
            type: Object,
            value: {
              question: '',
              imageURL: '',
              videoURL: ''
            },
            notify: true
          },
          videoURL: String,
          imageResizeResult: {
            type: Object,
            observer: 'handleImageResize'
          },
          largeImage: Object,
          smallImage: Object,
          placeHolderImage: String,
          questionId: String,
          user: Object
        }
      }

      handleImageResize(output) {
        if(!output) return;

        if(!this.judgement.imageURL) {
          this.updateImage(output);
          return;
        }

        const file = this.selectedImages[0];
        const extension = file.name.split('.')[1];
        

        if(!this.largeImage) {
          this.largeImage = output;
          console.log('saved large image');

          this.$.imageResizer.maxWidth = "400";
          this.$.imageResizer.maxHeight = "300";

          console.log('resized image to 400x300, processing..');
          this.$.imageResizer.processImageFile(this.selectedImages);

          return;
        }

        if(!this.smallImage) {
          this.smallImage = output;
          console.log('saved small image');

          this.$.imageResizer.maxWidth = "640";
          this.$.imageResizer.maxHeight = "480";
          this.$.imageResizer.imageQuality = "0.000001";
          this.$.imageResizer.outputType = "base64";

          console.log('set low quality and outputType to base64, processing..');
          this.$.imageResizer.processImageFile(this.selectedImages);
          return;
        }

        if(!this.placeHolderImage) {
          this.placeHolderImage = output;
          console.log('saved placeholder image');

          console.log('gathering info and submitting');
          this.continueSubmittingImageUpload();
        }
        
      }

      computeIfAddingVideo(judgementType) {
        return judgementType === "video";
      }

      resetForm() {
        this.selectedImages = null;
        this.judgement = {
          question: '',
          imageURL: '',
          videoURL: ''
        }
      }

      
      askForJudgement() {

        if (!this.selectedImages && !this.judgement.videoURL) {
          console.log("you need to upload an image or submit a video");
          return;
        }

        this.questionId = firebase
          .database()
          .ref('judgements')
          .push()
          .key;

        if (this.judgementType === "image") {
          this.resizeImages();
        } else if (this.judgementType === "video") {

          this.createVideoQuestion()
            .then(question => this.submitQuestion(question))
            .then(this.resetForm())
            .then(this.redirectToList())
            .catch(error => console.log(error));

        }

      }

      continueSubmittingImageUpload() {
        this.createImageQuestion()
          .then(question => this.submitQuestion(question))
          .then(this.resetForm())
          .then(this.redirectToList())
          .catch(error => console.log(error));
      }

      resizeImages() {
        this.$.imageResizer.outputType = "blob"; // move back from preview mode
        this.$.imageResizer.processImageFile(this.selectedImages);
      }

      redirectToList() {
        this.set("route.path", "/list");
      }

      submitQuestion(question) {
        return firebase
          .database()
          .ref('judgements')
          .child(this.questionId)
          .set(question);
      }

      createImageQuestion() {
        let question = {
          type: 'image',
          question: this.judgement.question,
          userImage: this.user ? this.user.photoURL : null,
          judged: false
        }

        return this.uploadImages()
          .then(uploadedFileURLs => {
            const updatedQuestion = Object.assign(uploadedFileURLs, question);
            return updatedQuestion;
          })
      }

      createVideoQuestion() {
        let question = {
          type: 'video',
          question: this.judgement.question,
          videoURL: this.judgement.videoURL,
          userImage: this.user ? this.user.photoURL : null,
          judged: false,
        }

        return Promise.resolve(question);
      }

      uploadImages() {

        const file = this.selectedImages[0];
        const extension = file.name.split('.')[1];

        const folderRef = firebase
          .storage()
          .ref('images')
          .child(this.questionId);

        

        return Promise.all([this.uploadLargeImage(extension, folderRef), this.uploadSmallImage(extension, folderRef)])
          .then(result => {
            const imageURLs = {
              largeImageURL: result[0],
              smallImageURL: result[1],
              placeHolderImage: this.placeHolderImage
            };
            return imageURLs;
            
          });
      }

      uploadLargeImage(extension, folderRef) {
        return folderRef.child(`large.${extension}`)
          .put(this.largeImage)
          .then(largeImage => {
            return largeImage.metadata.downloadURLs[0];
          });
      }

      uploadSmallImage(extension, folderRef) {
        return folderRef.child(`small.${extension}`)
          .put(this.smallImage)
          .then(smallImage => {
            return smallImage.metadata.downloadURLs[0];
          });
      }

      loadPreviewImage(event) {
        event.preventDefault();
        this.judgement.imageURL = null;

        this.getImageSize(this.selectedImages[0])
          .then(imageSize => {
            console.log(imageSize);
            if(imageSize.width < 960 || imageSize.height < 720) {
              this.$.imageResizer.maxWidth = imageSize.width;
              this.$.imageResizer.maxHeight = imageSize.height;
              console.log("image was small, setting large image size to", imageSize.width, imageSize.height);
            }
            this.$.imageResizer.processImageFile(this.selectedImages);
          });
      }

      getImageSize(image) {
        return new Promise((resolve, reject) => {
          const _URL = window.URL || window.webkitURL;

          const img = new Image();
          img.onload = e => {

            const width = e.target.width;
            const height = e.target.height;

            return resolve({
              width,
              height,
              size: image.size
            });
          }
          img.src = _URL.createObjectURL(image);
        });

      }

      updateImage(img) {
        this.set('judgement.imageURL', img);
      }

      handleError(error) {
        // console.error(error);
      }

      showRejectedFileError(event) {
        console.log('rejected')
        const toast = this.$.toast;
        toast.text = 'weee';
        toast.open();
      }
    }

    window.customElements.define(JudgeDaleAdd.is, JudgeDaleAdd);
  </script>
</dom-module>