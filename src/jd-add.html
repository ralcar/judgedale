<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel='import' href='../bower_components/vaadin-upload/vaadin-upload.html'>
<link rel='import' href='../bower_components/paper-toast/paper-toast.html'>
<link rel='import' href='../bower_components/paper-radio-group/paper-radio-group.html'>
<link rel='import' href='../bower_components/paper-button/paper-button.html'>
<link rel='import' href='../bower_components/paper-input/paper-input.html'>
<link rel='import' href='../bower_components/paper-button/paper-button.html'>
<link rel='import' href='../bower_components/iron-image/iron-image.html'>
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel='import' href='../bower_components/cpol-image/cpol-image.html'>
<link rel="import" href="shared-styles.html">
<link rel="import" href="jd-card.html">

<dom-module id="jd-add">
  <template>
    <style include="shared-styles">
       :host {
        display: block;

        padding: 10px;
      }

      .preview {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      vaadin-upload.orange {
        --primary-color: var(--paper-deep-orange-900);
      }

      paper-button.orange {
        background-color: var(--paper-deep-orange-900);
        color: #fff;
      }

      paper-radio-button.orange {
        --paper-radio-button-checked-color: var(--paper-deep-orange-900);
        --paper-radio-button-unchecked-color: var(--paper-deep-orange-900);
      }

      jd-card {
        width: 100%;
        max-width: 400px;
      }

      .card {
        width: 100%;
        max-width: 900px;
      }

      canvas {
        image-rendering: optimizeSpeed;
        image-rendering: -moz-crisp-edges;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: -o-crisp-edges;
        image-rendering: crisp-edges;
        -ms-interpolation-mode: nearest-neighbor;
      }

    </style>

    <app-location route="{{route}}"></app-location>
    <div class="preview">
      <div class="card">

        <paper-radio-group selected="{{judgementType}}" on-selected-changed="resetForm">
          <paper-radio-button class="orange" name="image">Image</paper-radio-button>
          <paper-radio-button class="orange" name="video">Video</paper-radio-button>
        </paper-radio-group>



        <div hidden$="{{addingVideo}}">

          <vaadin-upload id="imageUpload" class="orange" accept=".jpg,.png,.gif,.bmp" files="{{selectedImages}}" max-files="1" on-file-reject="showRejectedFileError"
            on-upload-before="loadPreviewImage">
          </vaadin-upload>

          <cpol-image
            id="imageResizer"
            output-data="{{imageResizeResult}}"
            output-type="base64"
            max-width="400"
            image-quality="0.8"
            on-this-error-changed="handleError">
          </cpol-image>

        </div>

        <div hidden$="{{!addingVideo}}">
          <paper-input label="Youtube link" value="{{judgement.videoURL}}"></paper-input>
        </div>

        <paper-input label="Question" value="{{judgement.question}}"></paper-input>

        <paper-input label="My name is" value="{{judgement.username}}"></paper-input>

        <paper-button class="orange" raised on-tap="askForJudgement">Judge me</paper-button>


        <paper-toast id="toast" horizontal-align="right"></paper-toast>
      </div>

      <h1>Preview</h1>
      
      <canvas id="canvas" width="500" height="400" hidden></canvas>
      <jd-card judgement="{{judgement}}" preview-mode></jd-card>
    </div>

  </template>

  <script>
    class JudgeDaleAdd extends Polymer.Element {
      static get is() {
        return 'jd-add';
      }

      static get properties() {
        return {
          judgementType: {
            type: String,
            value: "image"
          },
          addingVideo: {
            type: Boolean,
            computed: 'computeIfAddingVideo(judgementType)'
          },
          selectedImages: Array,
          judgement: {
            type: Object,
            value: {
              question: '',
              imageURL: '',
              videoURL: ''
            },
            notify: true
          },
          videoURL: String,
          imageResizeResult: {
            type: Object,
            observer: 'handleImageResize'
          },
          image: Object,
          imageSize: Object,
          previewImage: String,
          placeHolderImage: String,
          questionId: String,
          user: Object
        }
      }

      handleImageResize(output) {
        if(!output) return;

        // User selected image, measure it and show preview
        if(!this.previewImage) {
          this.getBase64ImageSize(output)
          .then(imageSize => {
            this.previewImage = output;
            this.imageSize = imageSize; // store for later!
            this.setPreviewImage(output, imageSize);
          });

          return;
        }

        // User has clicked submit, placeholder exists but not the blob image
        if(!this.image) {
          this.image = output;

          this.continueSubmittingImageUpload();
        }

      }

      computeIfAddingVideo(judgementType) {
        return judgementType === "video";
      }

      resetForm() {
        this.selectedImages = null;
        this.judgement = {
          question: '',
          imageURL: '',
          videoURL: ''
        }
      }
      
      askForJudgement() {

        if (!this.selectedImages && !this.judgement.videoURL) {
          console.log("you need to upload an image or submit a video");
          return;
        }

        this.questionId = firebase
          .database()
          .ref('judgements')
          .push()
          .key;

        if (this.judgementType === "image") {
          this.resizeImages();
        } else if (this.judgementType === "video") {

          this.createVideoQuestion()
            .then(question => this.submitQuestion(question))
            .then(this.resetForm())
            .then(this.redirectToList())
            .catch(error => console.log(error));

        }

      }

      continueSubmittingImageUpload() {
        this.createImageQuestion()
          .then(question => this.submitQuestion(question))
          .then(this.resetForm())
          .then(this.redirectToList())
          .catch(error => console.log(error));
      }

      resizeImages() {
        this.$.imageResizer.outputType = "blob"; // move back from preview mode
        this.$.imageResizer.processImageFile(this.selectedImages);
      }

      redirectToList() {
        this.set("route.path", "/list");
      }

      submitQuestion(question) {
        return firebase
          .database()
          .ref('judgements')
          .child(this.questionId)
          .set(question);
      }

      createImageQuestion() {

        return Promise.all([this.createPixelatedImage(), this.uploadImages()])
          .then(results => {
            const pixelatedImage = results[0];
            const uploadedFileURLs = results[1];

            let question = {
              type: 'image',
              question: this.judgement.question,
              userImage: this.user ? this.user.photoURL : null,
              imageHeight: this.imageSize.height,
              placeHolderImage: pixelatedImage,
              judged: false
            }

            const updatedQuestion = Object.assign(uploadedFileURLs, question);
            return updatedQuestion;
          });
      }

      createVideoQuestion() {
        let question = {
          type: 'video',
          question: this.judgement.question,
          videoURL: this.judgement.videoURL,
          userImage: this.user ? this.user.photoURL : null,
          judged: false,
        }

        return Promise.resolve(question);
      }

      uploadImages() {

        const file = this.selectedImages[0];
        const extension = file.name.split('.')[1];

        const folderRef = firebase
          .storage()
          .ref('images');

        return folderRef.child(`${this.questionId}.${extension}`)
          .put(this.image)
          .then(image => {
            return {
              imageURL: image.metadata.downloadURLs[0]
            }
          });
      }

      loadPreviewImage(event) {
        event.preventDefault();
        this.judgement.imageURL = null;
        this.$.imageResizer.processImageFile(this.selectedImages);
      }

      createPixelatedImage() {
        return new Promise((resolve, reject) => {
          const ctx = this.$.canvas.getContext('2d');
          const img = new Image();

          ctx.mozImageSmoothingEnabled = false;
          ctx.webkitImageSmoothingEnabled = false;
          ctx.imageSmoothingEnabled = false;

          img.onload = () => {
            var size = 5 * 0.01;

            const w = this.$.canvas.width * size;
            const h = this.$.canvas.height * size;
            
            ctx.drawImage(img, 0, 0, w, h);
            ctx.drawImage(this.$.canvas, 0, 0, w, h, 0, 0, this.$.canvas.width, this.$.canvas.height);          

            var jpegUrl = this.$.canvas.toDataURL("image/jpeg");

            return resolve(jpegUrl);
          };
          img.src = this.previewImage;
        });
      }

      getBase64ImageSize(base64) {
        return new Promise((resolve, reject) => {
          const image = new Image();
          image.onload = () => {
            return resolve({
              width: image.width,
              height: image.height
            });
          }
          image.src = base64;
        });
      }

      getImageSize(image) {
        return new Promise((resolve, reject) => {
          const _URL = window.URL || window.webkitURL;

          const img = new Image();
          img.onload = e => {

            const width = e.target.width;
            const height = e.target.height;

            return resolve({
              width,
              height,
              size: image.size
            });
          }
          img.src = _URL.createObjectURL(image);
        });

      }

      updateImage(img) {
        this.set('judgement.imageURL', img);
      }

      setPreviewImage(img, imageSize) {
        this.set('judgement.imageHeight', imageSize.height);
        this.set('judgement.placeHolderImage', img);
      }

      handleError(error) {
        // console.error(error);
      }

      showRejectedFileError(event) {
        console.log('rejected')
        const toast = this.$.toast;
        toast.text = 'weee';
        toast.open();
      }
    }

    window.customElements.define(JudgeDaleAdd.is, JudgeDaleAdd);
  </script>
</dom-module>